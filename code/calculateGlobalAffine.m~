function [WarpedFrame, WarpedMask, WarpedMaskOutline, WarpedLocalWindows] = calculateGlobalAffine(IMG1,IMG2,Mask,Windows)
% CALCULATEGLOBALAFFINE: finds affine transform between two frames, and applies it to frame1, the mask, and local windows.
    F1 = detectHarrisFeatures(rgb2gray(IMG1));
    F1_fg_loc = [];
    F1_fg_met = [];
    F1_fg_count = 0;
    for i = 1:F1.Count
        x = F1.location(i,1);
        y = F1.location(i,2);
        if Mask(x, y) == 1
            F1_fg_loc = [F1_fg_loc ; x y];
            F1_fg_met = [F1_fg_met ; F1.Metric(i)];
            F1_fg_count = F1_fg_count + 1;
        end
    end
    F1.Location = F1_fg_loc;
    F1.Metric = F1_fg_met;
    F1.Count = F1_fg_count;
    [feat1, valid_p1] = extractFeatures(rgb2gray(IMG1), F1);
    
    F2 = detectHarrisFeatures(rgb2gray(IMG2));
    [feat2, valid_p2] = extractFeatures(rgb2gray(IMG2), F2);
    
    indexPairs = matchFeatures(feat1, feat2);
    matchedP1 = valid_points1(index
    tform = estimateGeometricTransform(IMG1,IMG2, 'affine');
    WarpedMask = imwarp(Mask, tform, 'OutputView');
    WarpedMaskOutline = bwperim(Mask, 4);
    WarpedFrame = imwarp(IMG1, tform, 'OutputView');
    WarpedLocalWindows = transformPointsForward(Windows);
end

